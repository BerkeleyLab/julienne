<p align="center">
  <img width="250" height="250" src="https://github.com/user-attachments/assets/1a1c4f1a-f229-4d6d-bcaa-d5d9826ee639">
</p>

Julienne
========
Julienne is a modern Fortran unit-testing framework that includes utilities for manipulating strings
via Julienne's `string_t` derived type.  The target strings include command-line arguments accessed
via Julienne's `command_line_t` type  and format strings generated by functions in Julienne's `formats_m` module.

Users construct tests by
1. Extending Julienne's `test_t` abstract derived type,
2. Defining a `subject()` function that returns a description of the entity being tested,
3. Defining a `results()` function that
    - Defines a result comprised of an array of `test_result_t` objects.
    - Defines a local array of `test_description_t` objects, each of which encapsulates
        * A string describing a test performed by a test-diagnosis function and
        * The corresponding test-diagnosis function's name.

Test-diagnosis functions conform to the [`diagnosis_function_i`] abstract interface, which stipulates that
the function takes no arguments and produces a result of the `test_diagnosis_t` type.

Users have two ways to construct a `test_diagnosis_t` object:
1. Write an expression using Julienne's user-defined operators, which are inspired by natural language, or
2. Invoke one of Julienne's `test_diagnosis_t` constructor functions.

Approach 1 is simpler, covers several common use cases, and automates the construction of the diagnostic 
output to be printed when a test fails.  Approach 2 facilitates user-customization of diagnostic output 
using Julienne's string-handling capabilities to format the output.  Such string handling centers around
Julienne's `string_t` type. 

Alternatively, Julienne's `vector_test_description_t` type facilitates writing test functions that produce 
multiple test diagnoses. Such functions conform to Julienne's [`vector_test_diagnosis_i`] abstract interface, 
which requires conforming functions to produce a one-dimensional array of `test_diagnosis_t` objects.

Origin Story
------------

Julienne's name derives from the term for vegetables sliced into thin strings: julienned vegetables.
The [Veggies] and [Garden] unit-testing frameworks inspired the structure of Julienne's tests and output.
Julienne aims to be a more lightweight alternative that is more portable across compilers.

Getting Started
---------------
Please see the [example-test-suite README.md](./example/example-test-suite/README.md).

Compiler Support
----------------
The table below shows the compiler that Julienne fully or partially supports.  When built with a fully
supported compiler, all Julienne tests pass.  When built with a partially supported compiler, the Julienne
test suite skips some tests due to compiler bugs.  The test output reports which tests are skipped and
thereby details the features, if any, that are not supported with a given compiler.

Compiler         | Version(s) Tested        | Support
-----------------|--------------------------|----------------------
LLVM `flang-new` | 19, 20                   | full
NAG `nagfor`     | 7.2 Build 7227           | full
GCC `gfortran`   | 13.1.0, 14.2.0_1, 15.0.1 | partial (see 1 below)
Intel `ifx`      | 2025.4 Build 20241205    | partial (see 2 below)

Compiler bugs related to the following issues have been reported:

1. `gfortran` issues:
   - The `test_description_t` constructor's `diagnosis_function` actual argument must be a procedure pointer.
   - Each element of a `vector_test_description_t` array must be defined in a separate program statement.
   - The `string_t` type's `bracket` type-bound procedure causes a program crash.
   - The `string_t` type's `.all.` operator causes a program crash.
2. `ifx` issue:
   - Two `string_t` tests fail as described in issue [#51](https://github.com/BerkeleyLab/julienne/issues/51).


Building and Testing
--------------------

#### LLVM (`flang-new`) compiler
##### `flang-new` version 20 or later
```
export FPM_FC=flang-new
fpm test --compiler flang-new
```

##### `flang-new` version 19
Add the following command before the `fpm` command recommended above for LLVM 20 or later:
```
export FPM_FFLAGS="-mmlir -allow-assumed-rank"
```
where this `FPM_FFLAGS` setting turns on the support for Fortran's assumed-rank dummy arguments.

If you do not have access to LLVM 19 or 20, we recommend building the main branch of llvm-project from source.
A script that might be helpful for doing so is in the [handy-dandy] repository.

### NAG (`nagfor`) compiler
```
fpm test --compiler nagfor --flag -fpp
```

#### GNU (`gfortran`) compiler
##### `gfortran` versions 14 or higher
```
fpm test --compiler gfortran --profile release
```

##### `gfortran` version 13
```
fpm test --compiler gfortran --profile release --flag "-ffree-line-length-none"
```
where the `-ffree-line-length-none` turns on support for lines exceeding the Fortran 2018 limit of 132 columns.
(Fortran 2023 expands the allowable line length to 5,000 characters.)

#### Intel (`ifx`) compiler
```
fpm test --compiler ifx --flag "-fpp -O3 -coarray" --profile release
```

Documentation
-------------
See our online [documentation] or build the documentation locally by installing [FORD] and executing `ford ford.md`.

[Sourcery]: https://github.com/sourceryinstitute/sourcery
[Veggies]: https://gitlab.com/everythingfunctional/veggies
[Garden]: https://gitlab.com/everythingfunctional/garden
[here]: https://github.com/rouson/handy-dandy/blob/7caaa4dc3d6e5331914a3025f0cb1db5ac1a886f/src/fresh-llvm-build.sh
[documentation]: https:///berkeleylab.github.io/julienne/
[FORD]: https://github.com/Fortran-FOSS-Programmers/ford
[handy-dandy]: https://github.com/rouson/handy-dandy/blob/7caaa4dc3d6e5331914a3025f0cb1db5ac1a886f/src/fresh-llvm-build.sh
[`diagnosis_function_i`]: https://github.com/BerkeleyLab/julienne/blob/37bcc959efa8f9e27ae50fecfd37a6bf52ef0a43/src/julienne/julienne_test_description_m.f90#L16
[`vector_test_diagnosis_i`]: https://github.com/BerkeleyLab/julienne/blob/37bcc959efa8f9e27ae50fecfd37a6bf52ef0a43/src/julienne/julienne_vector_test_description_m.F90#L18
